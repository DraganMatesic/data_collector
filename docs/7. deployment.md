[← Back to index](1.%20index.md)

# Table Deployment

## Deploy Class <a id="deploy-class"></a>

**Source:** `data_collector/tables/deploy.py`

The `Deploy` class manages framework database schema creation and codebook seeding.

```python
from data_collector.tables.deploy import Deploy

api = Deploy()
```

On initialization, it connects to the database configured by `MainDatabaseSettings()`.

### Methods

| Method | Description |
|--------|-------------|
| `create_tables()` | Creates all tables defined in `Base.metadata` |
| `drop_tables()` | Drops all tables defined in `Base.metadata` |
| `recreate_tables()` | Drops then creates all tables (**destructive**) |
| `populate_tables()` | Seeds codebook tables with reference data |

## Deployment Steps

### Step 1: Configure Environment Variables

Set the required database connection variables:

```bash
# Required
DC_DB_MAIN_USERNAME=myuser
DC_DB_MAIN_PASSWORD=mypassword
DC_DB_MAIN_DATABASENAME=data_collector
DC_DB_MAIN_IP=localhost
DC_DB_MAIN_PORT=5432

# Optional
DC_DB_MAIN_SERVERNAME=myserver
```

### Step 2: Create Tables

```python
from data_collector.tables.deploy import Deploy

api = Deploy()
api.create_tables()
```

This creates all framework tables:
- `app_groups`, `app_parents`, `apps`, `app_db_objects`
- `runtime`, `c_runtime_codes`
- `logs`, `c_log_level`
- `c_cmd_flags`, `c_cmd_list`, `c_fatal_flags`, `c_run_status`
- `c_alert_severity`
- `example_table`

### Step 3: Seed Codebook Data

```python
api.populate_tables()
```

This populates reference tables with predefined values using SHA-based `Database.merge()` — ensuring codebook data matches the defined enums. Each seed record is hashed via `bulk_hash()` before merge, and comparison uses the default `sha` column.

> **Seed data source:** All codebook seed data is defined as Python `IntEnum`/`StrEnum` classes in `data_collector/enums/`. See [1.3. enums.md](1.3.%20enums.md) for the full enum reference.

> **Backward compatibility:** Codebook tables are referenced by foreign keys from `logs`, `runtime`, and `apps`. The `populate_tables()` method uses `merge()` with the default `delete=False`, which preserves all existing codes and only inserts new ones. Deprecated enum values are never removed from codebook tables — they are archived (soft-deleted) to maintain referential integrity with historical data.

### CLI Alternative

All deployment steps can be run from the terminal. See [8. cli.md](8.%20cli.md) for the full CLI reference.

```bash
# Full setup: create tables + seed codebooks
python -m data_collector.tables setup
```

## Seed Data Reference

### Command Flags (`c_cmd_flags`)

Source enum: `CmdFlag` from `data_collector.enums`

| ID | Description |
|----|-------------|
| 0 | Command pending |
| 1 | Command Executed |
| 2 | Command not executed, conditions not meet |

### Command List (`c_cmd_list`)

Source enum: `CmdName` from `data_collector.enums`

| ID | Name | Description |
|----|------|-------------|
| 1 | start | Start app |
| 2 | stop | Stop app |
| 3 | restart | Restart app |
| 4 | enable | Enable app |
| 5 | disable | Disable app |

### Fatal Flags (`c_fatal_flags`)

Source enum: `FatalFlag` from `data_collector.enums`

| ID | Description |
|----|-------------|
| 1 | Failed to start |
| 2 | App stopped, alert sent |
| 3 | Unexpected behaviour |

### Run Status (`c_run_status`)

Source enum: `RunStatus` from `data_collector.enums`

| ID | Description |
|----|-------------|
| 0 | App not running |
| 1 | App is running |
| 2 | App is stopped. Send command start or restart to start again. |

### Log Levels (`c_log_level`)

Source enum: `LogLevel` from `data_collector.enums` (values derived from Python's `logging` module constants)

| ID | Description |
|----|-------------|
| 0 | NOTSET |
| 10 | DEBUG |
| 20 | INFO |
| 30 | WARNING |
| 40 | ERROR |
| 50 | CRITICAL |

### Runtime Exit Codes (`c_runtime_codes`)

Source enum: `RuntimeExitCode` from `data_collector.enums`

| ID | Description |
|----|-------------|
| 0 | FINISHED |
| 1 | MANAGER_EXIT |
| 2 | ORPHAN_PID |
| 3 | CMD_DISABLE |
| 4 | CMD_RESET |
| 5 | CMD_STOP |
| 6 | CMD_START |

### Alert Severity (`c_alert_severity`)

Source enum: `AlertSeverity` from `data_collector.enums`

| ID | Description |
|----|-------------|
| 1 | INFO |
| 2 | WARNING |
| 3 | ERROR |
| 4 | CRITICAL |

## Verification

After deployment, verify with SQL:

```sql
-- Check tables exist
SELECT table_name FROM information_schema.tables
WHERE table_schema = 'public'
ORDER BY table_name;

-- Check codebook data
SELECT * FROM c_cmd_list;
SELECT * FROM c_run_status;
SELECT * FROM c_log_level;
SELECT * FROM c_runtime_codes;
SELECT * FROM c_alert_severity;
```

## Cross-Platform Deployment

Developed and tested primarily on Windows, but fully deployable on Linux including Docker containers and cloud environments.

## Production Considerations

> **Never use `recreate_tables()` in production.** It drops all tables and data.

For production environments:

1. Use `create_tables()` only for initial deployment — it's safe to call repeatedly (skips existing tables via `CREATE IF NOT EXISTS`).
2. Use `populate_tables()` after any codebook changes — it only inserts new codes and archives removed ones, preserving backward compatibility with historical data.
3. For schema changes to existing tables, consider integrating **Alembic** for incremental migrations.
