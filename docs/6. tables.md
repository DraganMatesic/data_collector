[‚Üê Back to index](1.%20index.md)

# Tables & ORM Models

## Overview

All ORM models in Data Collector inherit from `Base`, which combines SQLAlchemy's `DeclarativeBase` with framework features (`BaseModel` for repr/str). A consistent naming convention is enforced via `MetaData`.

**Source:** `data_collector/tables/shared.py`

```python
from sqlalchemy import MetaData
from sqlalchemy.orm import DeclarativeBase
from data_collector.utilities.database.main import BaseModel

NAMING_CONVENTION = {
    "ix": "ix_%(table_name)s_%(column_0_label)s",
    "uq": "uq_%(table_name)s_%(column_0_name)s",
    "ck": "ck_%(table_name)s_%(constraint_name)s",
    "fk": "fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s",
    "pk": "pk_%(table_name)s"
}

class Base(DeclarativeBase, BaseModel):
    metadata = MetaData(naming_convention=NAMING_CONVENTION)
```

## Creating New ORM Models <a id="creating-models"></a>

### Basic Table

```python
from sqlalchemy import Column, String, Integer, DateTime, func
from data_collector.tables.shared import Base
from data_collector.utilities.database.main import auto_increment_column

class MyTable(Base):
    __tablename__ = 'my_table'

    id = auto_increment_column()
    name = Column(String(256))
    value = Column(Integer)
    date_created = Column(DateTime, server_default=func.now())
```

### Table with SHA (for merge support)

```python
from sqlalchemy import Column, String, Integer, DateTime, func
from data_collector.tables.shared import Base
from data_collector.utilities.database.main import auto_increment_column

class Companies(Base):
    __tablename__ = 'companies'

    id = auto_increment_column()
    company_name = Column(String(256), index=True)
    country = Column(String(50))
    reg_number = Column(String(50), index=True)
    sha = Column(String(64), index=True)
    archive = Column(DateTime, comment="Archived when no longer in source")
    date_created = Column(DateTime, server_default=func.now())
```

### Table with SHAHashableMixin (auto-hash on creation)

```python
from sqlalchemy import Column, String, Integer
from data_collector.tables.shared import Base
from data_collector.utilities.database.main import auto_increment_column, SHAHashableMixin

class Companies(SHAHashableMixin, Base):
    __tablename__ = 'companies'

    id = auto_increment_column()
    company_name = Column(String(256))
    country = Column(String(50))
    reg_number = Column(String(50))

    @staticmethod
    def get_hash_keys() -> list:
        return ['company_name', 'country', 'reg_number']

# SHA computed automatically:
c = Companies(company_name="Acme", country="HR", reg_number="123")
print(c.sha)  # Already populated
```

## auto_increment_column() <a id="auto-increment"></a>

**Source:** `data_collector/utilities/database/main.py`

Returns a `Column` that works as an auto-incrementing primary key across supported databases (PostgreSQL, MSSQL).

```python
from data_collector.utilities.database.main import auto_increment_column
```

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `database_type` | DatabaseType | None (auto-detect) | Override the target database type |
| `primary_key` | bool | True | Whether this column is a primary key |
| `**col_kw` | | | Extra kwargs forwarded to `Column()` |

### Behavior per Database

| Database | Strategy |
|----------|----------|
| PostgreSQL | `Column(BigInteger, Identity(always=True))` |
| MSSQL / SQLite | `Column(BigInteger, autoincrement=True)` |

When `database_type` is None, it reads from `MainDatabaseSettings()` to detect the target database.

## BaseModel <a id="base-model"></a>

**Source:** `data_collector/utilities/database/main.py`

Provides `__repr__` and `__str__` for all ORM models:

```python
obj = ExampleTable(company_id=100, name="John")
print(obj)
# <ExampleTable(id=None, company_id=100, name='John', ...)>
```

## Framework Tables

For the complete schema reference of all framework tables, see [1.2. data-model.md](1.2.%20data-model.md).

Quick reference:

| Table | Purpose | Key Columns |
|-------|---------|-------------|
| `app_groups` | Logical grouping of apps | `name` (unique) |
| `app_parents` | Parent/service within a group | `name`, `group_name` (composite PK) |
| `apps` | Core app registry and lifecycle | `app` (hash), scheduling, commands, fatal tracking |
| `app_db_objects` | Database dependency map | `app_id`, `object_name`, `object_type` |
| `runtime` | Per-execution metrics | `runtime` (hash), duration, exit code |
| `logs` | Structured application logs | `app_id`, `runtime`, `msg`, `log_level` |
| `example_table` | Documentation examples | `company_id`, `person_id`, `sha` |

## ExampleTable <a id="example-table"></a>

A simple table for documentation and testing:

```python
from data_collector.tables.examples import ExampleTable
```

| Column | Type | Description |
|--------|------|-------------|
| `id` | BigInteger (PK) | Auto-increment |
| `company_id` | Integer (indexed) | Company identifier |
| `person_id` | Integer (indexed) | Person identifier |
| `name` | String(15) | First name |
| `surname` | String(25) | Last name |
| `birth_date` | Date | Date of birth |
| `sha` | String(64) | Hash for merge operations |
| `archive` | DateTime | Archive timestamp |
| `date_created` | DateTime | Record creation (default: NOW()) |
| `date_modified` | DateTime | Last modification timestamp |

## Standard Columns <a id="standard-columns"></a>

All data tables enforce a standard set of columns via `DataTableMixin`:

| Column | Type | Description |
|--------|------|-------------|
| `id` | BigInteger (PK) | Auto-incrementing primary key |
| `sha` | String(64) | Deterministic hash for change detection |
| `archive` | DateTime | Marks record as archived (soft delete) |
| `date_created` | DateTime | Record creation timestamp (server default) |
| `date_modified` | DateTime | Last modification timestamp |

Codebook tables follow a slightly different pattern:

| Column | Type | Description |
|--------|------|-------------|
| `id` | Integer (PK) | Enum value (from Python IntEnum/StrEnum) |
| `description` | String | Human-readable description |
| `sha` | String(64) | Hash for merge-based seeding |
| `archive` | DateTime | Archive timestamp |
| `date_created` | DateTime | Record creation timestamp |
