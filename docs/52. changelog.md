[← Back to index](1.%20index.md)

# Changelog

All notable changes to the Data Collector framework are documented in this file.

Format follows [Keep a Changelog](https://keepachangelog.com/en/1.1.0/).
Versioning follows [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

---

## [Unreleased]

### Added

**Documentation:**
- Full documentation suite (40+ files covering architecture, features, guides, and operations)
- Pass 2 enterprise documentation polish: fixed broken links and missing asset references, formalized style in secrets docs, added planned-path labeling contract, consolidated documentation governance in the contributing guide, and added automated docs validation workflow (`docs-quality`)
- Runtime logging: initial logic for tracking individual app execution times

**Data Model:**
- `AppFunctions` table — function registry auto-populated by `@fun_watch` decorator with `function_hash` identity and in-process caching
- `FunctionLog` table — per-function execution metrics (task_size, solved, failed, timing) linked to `AppFunctions` via `function_hash`
- `PipelineTask` table — document processing state tracking (stage, status, timestamps, errors)
- `ProxyReservation` table — IP reservation with domain-level locking, TTL-based auto-expiry, atomic INSERT-or-fail pattern via unique partial index
- `context_json` TEXT column on `Logs` table — arbitrary structured context from structlog, overflow key-value pairs beyond fixed indexed columns
- Request timing columns on `Runtime` table — `request_count`, `avg_response_ms`, `p95_response_ms`, `error_rate`

**Logging:**
- structlog as logging frontend — bound context (app_id, runtime auto-attached), structured key-value output, JSON renderer for production
- Layered context binding lifecycle — app_id (static), runtime (per cycle), function_id (per function via `@fun_watch`), instance_id (per thread)
- `RouterHandler` fallback file logging — sink failures written to `error.log` via `RotatingFileHandler` with handler name, exception, traceback, and original record
- Custom structlog processors: `extract_caller_info()`, `limit_context_size()`, `separate_fixed_context()`
- `LogSettings` additions: `log_format` (console/json), `log_level`, `log_call_chain`, `log_error_file`, `log_error_max_bytes`, `log_error_backup_count`

**Scraping Infrastructure:**
- `BaseScraper` base class with convention-based lifecycle hooks (`prepare_list`, `collect`, `store`, `cleanup`), error tracking, progress monitoring, fatal_check
- Centralized `Request` class — setter methods for session state (`set_headers()`, `set_cookies()`, `set_auth()`, `set_proxy()`), constructor for transport config only (timeout, retries, backoff_factor)
- `RequestMetrics` — thread-safe shared metrics collector with reservoir sampling (P50/P95/P99), per-domain timing, status code distribution, per-proxy breakdown, circuit breaker (`is_target_unhealthy()`)
- `ExceptionDescriptor` — timestamped errors, grouped exception handling (Timeout/Proxy/HTTP/Redirect/General), error introspection (`is_blocked`, `is_proxy_error`, `is_timeout`, `should_abort()`)
- `ProxyProvider` interface with `build_proxy_url(session_id)` method, `BrightDataProvider` as shipped implementation
- `ProxyManager` — acquisition flow with proxy judges (failover), atomic IP reservation, TTL-based crash safety
- App scaffold CLI — `python -m data_collector scaffold` generates `main.py`, `parser.py`, `tables.py` from templates, auto-registers in Apps table

**Database:**
- `DbExecutable` dataclass for `Database.execute()` — structured `object_name`, `object_type` (DbObjectType enum: PROCEDURE, FUNCTION), `schema`, `params`; builds correct SQL per DB type (CALL for Postgres, EXEC for MSSQL)
- `UnicodeParams` dataclass + `UnicodeForm` enum for `make_hash()` — Unicode normalization (NFC/NFD/NFKC/NFKD), regex preprocessing, deep normalization into nested dicts/lists

**Orchestration:**
- Manager architecture positioning — custom Manager as primary orchestrator with dynamic scheduling, PID management, real-time progress tracking
- Service deployment — native Windows Service (pywin32), Linux systemd, Docker (replacing NSSM)
- App arguments via `init(runtime, args=None)` — JSON dict from Manager subprocess CLI, RabbitMQ command payload, or direct execution
- `get_app_info(__file__)` — convention-based app_id derivation from file path, replaces hardcoded hash strings
- UUID4 runtime IDs — `uuid.uuid4().hex` (32 chars) replacing SHA-256 datetime hash (64 chars)

**Task Processing:**
- Dramatiq integration with RabbitMQ broker — declarative queue topology via dataclasses (`TopicExchange`, `TopicExchangeQueue`, `RegularQueue`)
- `TaskDispatcher` — DB-driven dispatch polling Events table for unprocessed events, batch processing with `yield_per`
- Broker management — AST-based actor validation, self-healing binding synchronization, `clean_dead_queues()` topology cleanup
- `WatchService` — file system monitoring via watchdog as event producer to Events table, platform-aware observers, file stability debounce, TTL-based deduplication, UNC path normalization

**Notifications:**
- Pluggable notification system — Telegram, Teams, Slack, email, webhooks via channel adapters
- `AlertSeverity` enum in `enums/notifications.py` (INFO, WARNING, ERROR, CRITICAL)

**REST API & Dashboard:**
- FastAPI management API with OAuth2 + JWT (PyJWT) authentication and role-based access control
- OAuth2 Client Credentials flow for service-to-service authentication (Teams Copilot, bots, automation)
- Dash (Plotly) mounted inside FastAPI as WSGI middleware — single deployment, single port, shared auth
- `dash-ag-grid` enterprise data tables with `dcc.Interval` auto-refresh (3–5s) and WebSocket for instant log streaming
- Security hardening — CORS lockdown, token revocation via `jti` blacklist, refresh token rotation, rate limiting (slowapi), security headers (HSTS, CSP, X-Frame-Options), audit logging

**Enums:**
- `DbObjectType` IntEnum in `enums/database.py` (PROCEDURE, FUNCTION)
- `UnicodeForm` StrEnum in `enums/hashing.py` (NFC, NFD, NFKC, NFKD)
- `AlertSeverity` IntEnum in `enums/notifications.py` (INFO, WARNING, ERROR, CRITICAL)

### Changed
- Documentation hierarchy canonicalization: app module paths now use `data_collector/<country>/<parent>/<app>/` (replacing `apps/...` examples), and enum paths remain locked at `data_collector/enums/*`
- Test hierarchy canonicalization: legacy ad-hoc files removed from the package test tree; canonical automated test suite defined at repository-level `tests/` with `unit`, `quality`, and `integration` layers
- Migrated logging frontend from stdlib `logging` to `structlog` — bound context, JSON/console renderers, processor chain
- Migrated `Database.query()` from SQLAlchemy 1.x `session.query()` to 2.x `select()` + `session.execute()` pattern
- `Database.execute()` now accepts `DbExecutable` dataclass instead of raw SQL string parsing; removed Oracle package procedure concept
- `make_hash()` accepts optional `unicode: UnicodeParams` and `regex: re.Pattern` parameters for preprocessing
- `BaseScraper` lifecycle: `search_data()` → `collect()`, `parse_data()` removed from base class (parsing via separate `parser.py` module), `store_data()` → `store()`
- `Request` class: session state via setter methods (`set_headers()`, `reset_headers()`, etc.) instead of constructor parameters
- `prepare_list()` returns DB query results (registry numbers, IDs), not URLs
- `init(runtime)` → `init(runtime, args=None)` with optional runtime arguments dict
- `app_id` derived from `get_app_info(__file__)` instead of hardcoded `make_hash("group|parent|name")`
- Runtime ID generation: `sha256(datetime.now() + app_id)` → `uuid.uuid4().hex`
- `RouterHandler`: handlers must not catch own exceptions — exceptions propagate to RouterHandler as single point of failure handling
- `DatabaseHandler`: uses Logs ORM model with correct columns instead of raw SQL to non-existent `app_logs` table
- `FunctionLog`: `function_id` replaced by `function_hash` FK → `AppFunctions.function_hash`; `function_name` and `filepath` moved to `AppFunctions` registry
- RabbitMQ and Dramatiq split into separate docs (17. rabbitmq.md + 17.1. dramatiq.md)
- WatchService split from Dramatiq into separate doc (17.2. watchdog.md)
- Telegram doc renamed to Notifications (18. notifications.md) — pluggable channel system
- Codebook `populate_tables()` default: `delete=False` in production to protect FK references
- Captcha: single provider (AntiCaptcha) instead of multi-service adapter pattern
- Proxy: `ProxyProvider` interface replaces proxy pool/rotation strategies — providers handle IP selection via super-proxy gateway
- REST API dependencies: `python-jose` → `PyJWT`, `passlib` → `pwdlib`
- Dashboard: Streamlit → Dash mounted inside FastAPI
- Health endpoint split: unauthenticated `/health` returns only status, authenticated endpoint returns full component breakdown

### Removed
- Oracle / oracledb / cx_Oracle database support (PostgreSQL + MSSQL only; `BaseDBConnector` remains pluggable)
- `FunctionProfile` table and `line_profiler` dependency (replaced by `FunctionLog` + `@fun_watch` for production monitoring; developers use cProfile/line_profiler locally)
- `22. ocr-pipelines.md` — content fully covered by 17.1. dramatiq.md, 14. pdf-ocr.md, 21. deep-learning-ner.md
- `23. event-driven.md` — Blinker event bus removed; no concrete problem justified the indirection
- Oracle package procedure concept from `Database.execute()` and `get_routine_type()`
- TwoCaptcha from supported captcha services
- Proxy pool file/DB lists and rotation strategies (round-robin, random, LRU)
- NSSM for Windows service deployment (replaced by native Windows Service via pywin32)
- Streamlit dashboard dependency
- Event Bus from REST API architecture

---

## [0.1.0] — Foundation Release

### Added

**Core Framework:**
- `Database` class with multi-database support (PostgreSQL, MSSQL; pluggable `BaseDBConnector` for future additions)
- `BaseDBConnector` factory pattern with `Postgres`, `MsSQL` connectors
- `merge()` method for SHA-based data synchronization (insert new, archive/delete removed)
- `bulk_insert()`, `update_insert()`, `query()`, `execute()`, `delete()`, `archive()` methods
- `SHAHashableMixin` for declarative hash column configuration
- `Stats` dataclass for merge operation reporting
- `auto_increment_column()` for cross-database auto-increment compatibility
- `BaseModel` mixin with `to_dict()`, `from_dict()`, `__repr__` utilities

**ORM & Data Model:**
- `Base` class combining `DeclarativeBase` + `BaseModel` with naming conventions
- `Apps` table — app registry with scheduling, commands, and fatal tracking
- `AppGroups` and `AppParents` — hierarchical app organization
- `AppDbObjects` — automatic dependency tracking (tables/views/procedures per app)
- `Runtime` table — execution history with start/end times and status codes
- `Logs` table — structured log storage with level, message, and exception fields
- Codebook tables: `CodebookLogLevel`, `CodebookRuntimeCodes`, `CodebookRunStatus`, `CodebookCommandFlag`, `CodebookCommandList`, `CodebookFatalFlag`
- `ExampleTable` — reference implementation for new ORM models

**Logging System:**
- `LoggingService` — queue-based async logging with `QueueHandler` → `QueueListener`
- `RouterHandler` — observer pattern broadcasting to multiple sinks
- `DatabaseHandler` — log-to-database sink
- `SplunkHECHandler` — Splunk HTTP Event Collector sink
- Console and rotating file handlers

**Settings & Configuration:**
- `DatabaseSettings` — database connection configuration via Pydantic
- `MainDatabaseSettings` — extends `DatabaseSettings` with schema management
- `LogSettings` — logging level, file paths, Splunk configuration
- `GeneralSettings` — application-wide settings
- Environment variable support with `DC_` prefix

**Utilities:**
- `make_hash()` — SHA-256 hash generation from dictionary fields
- `bulk_hash()` — batch hash computation for ORM object lists
- `obj_diff()` — compare ORM objects against database records
- `object_to_dict()` — ORM/Row object serialization
- Time converters: `utc_to_local()`, `local_to_utc()`, `timer()`, `timer_to_str()`
- Math utilities: `get_totals()`, `get_totalm()`, `get_totalh()` (time unit conversions)
- `is_module_available()` — optional dependency detection
- `list_enum_values()` — extract values from Python enums

**Deployment:**
- `Deploy` class with `create_tables()`, `drop_tables()`, `recreate_tables()`
- `populate_tables()` for codebook seed data
- `SeedData` dataclass for custom seed data injection

**Security:**
- `SecretLoader` — AES-256-CBC encryption for sensitive configuration
- PBKDF2 key derivation with configurable iterations

---

## Roadmap

See [50. roadmap.md](50.%20roadmap.md) for the Kanban-based implementation plan:
- **v0.2.0** — Core Application Infrastructure (WP-01 Enums, WP-02 Request, WP-03 @fun_watch)
- **v0.3.0** — Scraping & Collection (WP-04 BaseScraper, WP-05 Proxy, WP-06 Captcha + Concurrency)
- **v0.4.0** — Messaging & Orchestration (WP-07 Notifications, WP-08 RabbitMQ, WP-09 Manager)
- **v0.5.0** — Pipeline & Integration (WP-10 Dramatiq, WP-11 WatchService, WP-12 SOAP/PDF/OCR/Storage)
- **v0.6.0** — Advanced Features (WP-13 NER Pipeline)
- **v1.0.0** — Platform Release (WP-14 REST API, WP-15 Dashboard + Security + Docker)
