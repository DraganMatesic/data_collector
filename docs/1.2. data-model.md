[← Back to index](1.%20index.md)

# Data Model

## Overview

Data Collector uses its own database schema to track applications, runtime metrics, logs, function performance, commands, pipeline state, and database object dependencies. All tables are deployed via the `Deploy` class to the database configured in `MainDatabaseSettings`.

The framework schema serves three purposes:
1. **Operational** — Track what's running, what failed, what commands are pending
2. **Observability** — Log everything, measure runtime and function performance, map database dependencies
3. **Pipeline state** — Track document processing stages, status, and errors

## Table Standards

All framework tables follow enforced column conventions via base mixins. This ensures consistency across the entire schema.

### Data Table Standard

Every data table includes these columns:

| Column | Type | Description |
|--------|------|-------------|
| `id` | BigInteger | PK, auto-increment |
| `sha` | String(64) | Hash of business columns (for merge/change detection) |
| `archive` | DateTime | NULL = active record, timestamp = soft-deleted |
| `date_created` | DateTime | Server default NOW(), set on insert |
| `date_modified` | DateTime | Updated automatically on modification |

**Enforcement:** Tables inherit from `Base` which includes `DataTableMixin`:
```python
class DataTableMixin:
    sha = mapped_column(String(64), index=True)
    archive = mapped_column(DateTime, nullable=True)
    date_created = mapped_column(DateTime, server_default=text("NOW()"))
    date_modified = mapped_column(DateTime, onupdate=func.now(), nullable=True)
```

### Codebook Table Standard

Codebook (reference/lookup) tables use enum-sourced IDs instead of auto-increment:

| Column | Type | Description |
|--------|------|-------------|
| `id` | Integer | Enum value (not auto-increment), unique |
| `description` | String(128) | Human-readable label from enum |
| `sha` | String(64) | Hash for merge() consistency |
| `archive` | DateTime | NULL = active, timestamp = deprecated |
| `date_created` | DateTime | Server default NOW() |

**Key rules:**
- Codebook IDs come from Python enums — they are never auto-generated
- Codebooks use **archive mode** in merge() (not delete) — deprecated values remain readable for historical data
- DB-level FK constraints from data tables to codebooks are enforced
- Enum values grow forward, never recycled. Deprecate by archiving, don't reuse IDs

## Enum Definitions

All constant values (flags, status codes, command names, log levels) are defined as Python enums in `data_collector/enums/`. Enums serve dual purpose: seeding codebook tables AND providing type-safe constants in application code — no magic numbers anywhere.

See [1.3. Enums](1.3.%20enums.md) for complete definitions, usage patterns, and guidelines for adding new enums.

## Entity Relationship Diagram

```
                    ┌──────────────┐
                    │  app_groups   │
                    │──────────────│
                    │ id (auto PK) │
                    │ name (unique)│
                    └──────┬───────┘
                           │ 1:N
                    ┌──────┴───────────┐
                    │   app_parents     │
                    │──────────────────│
                    │ id (auto)        │
                    │ parent (hash,uq) │
                    │ name (PK)        │
                    │ group_name (PK)──│──FK──► app_groups.name
                    └──────┬───────────┘
                           │ 1:N
                    ┌──────┴──────────────────┐
                    │         apps             │
                    │─────────────────────────│
                    │ id (auto)               │
                    │ app (hash, unique, idx) │
                    │ group_name (PK)         │
                    │ parent_name (PK)────────│──FK──► app_parents(group_name, name)
                    │ app_name (PK)           │
                    │ parent_id ──────────────│──FK──► app_parents.parent
                    │ run_status ─────────────│──FK──► c_run_status.id
                    │ fatal_flag ─────────────│──FK──► c_fatal_flags.id
                    │ cmd_name ───────────────│──FK──► c_cmd_list.id
                    │ cmd_flag ───────────────│──FK──► c_cmd_flags.id
                    │ last_run, next_run      │
                    │ task_size, progress     │
                    │ solved, failed          │
                    │ disable (default: true) │
                    │ eta                     │
                    │ + standard columns      │
                    └──────┬──────────────────┘
                           │
              ┌────────────┼────────────┬──────────────┐
              │            │            │              │
    ┌─────────┴──┐  ┌─────┴─────┐  ┌──┴──────────┐  ┌┴──────────────┐
    │   runtime   │  │   logs    │  │ app_db_     │  │ app_functions  │
    │────────────│  │───────────│  │ objects     │  │───────────────│
    │ runtime    │  │ app_id    │  │────────────│  │ function_hash │
    │ (hash,uq)  │  │ runtime──│  │ app_id     │  │ function_name │
    │ app_id     │  │ log_level │  │ server_type│  │ filepath      │
    │ task_size  │  │ msg       │  │ server_name│  │ app_id        │
    │ start/end  │  │ ctxt_json │  │ db_name    │  │ first/last_seen│
    │ except_cnt │  │ + std cols│  │ schema     │  │ + std cols    │
    │ exit_code  │  └───────────┘  │ object_name│  └──────┬────────┘
    │ + std cols │                  │ object_type│         │
    └─────┬──────┘                  │ last_use   │  ┌──────┴────────┐
          │                         │ + std cols │  │ function_log  │
          │                         └────────────┘  │───────────────│
          │                                         │ function_hash─│─FK
          │                                         │ app_id        │
          │                                         │ runtime ──────│─FK
          │                                         │ thread_id     │
          │                                         │ task_size     │
          │                                         │ solved/failed │
          │                                         │ start/end     │
          │                                         │ totals/m/h    │
          │                                         │ + std cols    │
          │                                         └───────────────┘
    ┌─────┴────────────┐           └────────────┘
    │  command_log      │
    │──────────────────│
    │ app_id           │
    │ cmd_by, cmd_name │
    │ cmd_time/exec    │
    │ cmd_flag         │
    │ + std cols       │
    └──────────────────┘

    ┌─────────────── Codebook Tables (enum-sourced) ──────────────┐
    │  c_cmd_flags    c_cmd_list    c_fatal_flags                 │
    │  c_run_status   c_log_level   c_runtime_codes               │
    │  (all: id from enum, description, sha, archive, date_created│
    └─────────────────────────────────────────────────────────────┘

    ┌─────────────────── Pipeline Tables ───────────────────┐
    │  pipeline_task (stage tracking per document)          │
    │  + standard columns                                   │
    └───────────────────────────────────────────────────────┘
```

## App Lifecycle Tables

### AppGroups

Logical grouping for applications (e.g., by country or department).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Unique identifier |
| `name` | String(256) | UNIQUE | Group name (e.g., "croatia", "serbia") |
| `sha` | String(64) | INDEX | Standard: hash |
| `archive` | DateTime | | Standard: soft-delete |
| `date_created` | DateTime | default: NOW() | Standard: creation timestamp |
| `date_modified` | DateTime | | Standard: modification timestamp |

**Source:** `data_collector/tables/apps.py`

### AppParents

Parent/service grouping within an `AppGroup`. Represents a logical service containing one or more apps.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | auto-increment | Sequence ID |
| `parent` | String(64) | UNIQUE | Hash identifier for the parent |
| `name` | String(256) | PK (composite) | Parent name (e.g., "fina", "apr") |
| `group_name` | String | PK (composite), FK → `app_groups.name` | Group this parent belongs to |
| + standard columns | | | sha, archive, date_created, date_modified |

**Primary Key:** Composite (`name`, `group_name`)

### Apps

Core table tracking individual application configurations and runtime states.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | auto-increment | Sequence ID |
| `app` | String(64) | UNIQUE, INDEX | SHA hash identifier for the app |
| `group_name` | String(256) | PK (composite) | Group name |
| `parent_name` | String(256) | PK (composite) | Parent name |
| `app_name` | String(256) | PK (composite) | Application name |
| `parent_id` | String | FK → `app_parents.parent` | Link to parent |
| `last_run` | DateTime | | Timestamp of last app run |
| `next_run` | DateTime | | Timestamp of next scheduled run |
| `app_pids` | Text | | List of process IDs connected to app |
| `run_status` | Integer | FK → `c_run_status.id`, default: 0 | Current run state (enum: `RunStatus`) |
| `task_size` | Integer | | Total items to process in current loop |
| `progress` | Integer | | Completion percentage (0-100) |
| `solved` | Integer | default: 0 | Successfully processed items in current loop |
| `failed` | Integer | default: 0 | Items that ended with error in current loop |
| `fatal_flag` | Integer | FK → `c_fatal_flags.id`, default: 0 | Fatal error state (enum: `FatalFlag`) |
| `fatal_msg` | Text | | Reason for fatal status |
| `fatal_time` | DateTime | | When fatal flag was set |
| `runtime_id` | String(64) | | Link to runtime metadata |
| `cmd_by` | String(128) | | User who issued last command |
| `cmd_name` | Integer | FK → `c_cmd_list.id` | Last command (enum: `CmdName`) |
| `cmd_time` | DateTime | | When command was issued |
| `cmd_flag` | Integer | FK → `c_cmd_flags.id`, default: 0 | Command status (enum: `CmdFlag`) |
| `cmd_exec` | DateTime | | When command was executed |
| `disable` | Boolean | default: true | Whether app is disabled |
| `eta` | DateTime | | Estimated time of completion, updated during runtime |
| + standard columns | | | sha, archive, date_created, date_modified |

**Primary Key:** Composite (`group_name`, `parent_name`, `app_name`)

**Hierarchy:** `AppGroups` → `AppParents` → `Apps` (cascading deletes)

### AppDbObjects

Automatically populated dependency map. Records every database object (table, view, procedure, function) that each app interacts with during runtime.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Unique identifier |
| `app_id` | String(64) | INDEX | Hash ID of the app |
| `server_type` | String(50) | | Database type (Postgres, MsSQL) |
| `server_name` | String(50) | | Server hostname |
| `server_ip` | String(50) | | Server IP address |
| `database_name` | String(50) | | Database name |
| `database_schema` | String(50) | | Schema name |
| `object_name` | String(75) | | Table/view/procedure name |
| `object_type` | String(20) | | Object type: table, view, function, procedure |
| `last_use_date` | DateTime | | When this object was last accessed |
| + standard columns | | | sha (used for dedup), archive, date_created, date_modified |

## Runtime Tables

### Runtime

Tracks a single execution cycle of an application.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Unique identifier |
| `runtime` | String(64) | UNIQUE, INDEX | Hash of `datetime.now()` representing this run |
| `app_id` | String(64) | INDEX | Hash ID of the app |
| `task_size` | BigInteger | | Size of processing list (null = crawl-based) |
| `start_time` | DateTime | | When execution started |
| `end_time` | DateTime | | When execution ended |
| `totals` | Integer | | Total runtime in seconds |
| `totalm` | Integer | | Total runtime in minutes |
| `totalh` | Integer | | Total runtime in hours |
| `except_cnt` | Integer | default: 0 | Number of exceptions during runtime |
| `exit_code` | Integer | default: 0 | Process exit code (enum: `RuntimeExitCode`) |
| `request_count` | Integer | nullable | Total HTTP requests made during this runtime |
| `avg_response_ms` | Integer | nullable | Average response time in milliseconds |
| `p95_response_ms` | Integer | nullable | 95th percentile response time in milliseconds |
| `error_rate` | Float | nullable | HTTP error rate as percentage (0.0–100.0) |
| + standard columns | | | sha, archive, date_created, date_modified |

### CodebookRuntimeCodes

Reference table for runtime exit codes. Seeded from `RuntimeExitCode` enum.

| Column | Type | Description |
|--------|------|-------------|
| `id` | Integer | Enum value from `RuntimeExitCode` |
| `description` | String(128) | Human-readable description |
| `sha` | String(64) | Hash for merge() |
| `archive` | DateTime | NULL = active, timestamp = deprecated |
| `date_created` | DateTime | Server default NOW() |

## Function Tracking

### AppFunctions

Function registry populated automatically by `@fun_watch` on first invocation. Provides a stable inventory of all decorated functions across the framework — one row per unique function per app.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Row identifier |
| `function_hash` | String(64) | UNIQUE, INDEX | Hash of (app_id + function_name) — stable function identity |
| `function_name` | String(125) | | Decorated function/method name |
| `filepath` | String(1024) | | Module path where function is defined |
| `app_id` | String(64) | FK → `apps`, INDEX | Owning application |
| `first_seen` | DateTime | | First time this function was registered |
| `last_seen` | DateTime | | Most recent invocation timestamp |
| + standard columns | | | sha, archive, date_created, date_modified |

**Auto-registration:** The `@fun_watch` decorator computes the `function_hash` and checks an in-process cache. On first invocation (cache miss), it upserts to `app_functions` and caches the hash. Subsequent calls within the same process skip the DB check entirely.

### FunctionLog

Per-function execution timing, populated by the `@fun_watch` decorator. Answers "which function ran, how long did it take, and how much data did it process?" within a runtime cycle.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Row identifier |
| `function_hash` | String(64) | FK → `app_functions.function_hash`, INDEX | Links to function registry |
| `function_no` | Integer | | Execution order within the app (per-thread) |
| `main_app` | String(64) | INDEX | Hash of the root app |
| `app_id` | String(64) | INDEX | Hash of app_group + app_parent + app_name |
| `thread_id` | Integer | | Thread ID running this function instance |
| `task_size` | BigInteger | | Size of list/dataset given to the function |
| `solved` | Integer | default: 0 | Successfully processed items |
| `failed` | Integer | default: 0 | Items that ended with error |
| `start_time` | DateTime | | When function execution started |
| `end_time` | DateTime | | When function execution ended |
| `totals` | Integer | | Function runtime in seconds |
| `totalm` | Integer | | Function runtime in minutes |
| `totalh` | Integer | | Function runtime in hours |
| `runtime` | String(64) | FK → `runtime.runtime`, INDEX | Links to execution cycle |
| + standard columns | | | sha, archive, date_created, date_modified |

**Use case:** Production performance monitoring. Apps table shows live dashboard (current loop only). FunctionLog preserves the historical record — every loop from every runtime with task_size, solved, and failed counts. When an app's runtime increases, query FunctionLog to identify which function is the bottleneck and whether failures are increasing. Function metadata (name, filepath) is stored once in `app_functions`, not repeated per log row. For line-level profiling, developers use `cProfile` or `line_profiler` locally.

## Command Tracking

### CommandLog

Audit trail for commands sent to the orchestration manager (start, stop, restart, disable). Records who issued the command, when it was issued, and when it was executed.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Unique identifier |
| `app_id` | String(64) | INDEX | Hash ID of the target app |
| `cmd_by` | String(128) | | Name of person who initiated the command |
| `cmd_name` | String(128) | | Command name (enum: `CmdName`) |
| `cmd_time` | DateTime | | When the command was received |
| `cmd_flag` | Integer | default: 0 | Status (enum: `CmdFlag`) |
| `cmd_exec` | DateTime | | When the command was executed |
| + standard columns | | | sha, archive, date_created, date_modified |

## Logging Tables

### Logs

Structured application logs with call chain tracking.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Unique identifier |
| `app_id` | String(64) | FK → `apps.app`, INDEX | Root caller app |
| `module_name` | String(256) | | Python module name (.py file) |
| `module_path` | Text | | Full path to the module |
| `function_name` | String(256) | | Function that emitted the log |
| `function_id` | String(64) | INDEX | Hash of app_id + module + function |
| `call_chain` | Text | | Trace from root caller to log emitter |
| `instance_id` | Integer | | Differentiates parallel instances |
| `lineno` | Integer | | Line number where log was called |
| `log_level` | Integer | FK → `c_log_level.id`, INDEX | Numeric log level (enum: `LogLevel`) |
| `msg` | Text | | Log message content |
| `context_json` | Text | nullable | Arbitrary structured context as JSON (overflow from structlog key-value pairs) |
| `runtime` | String(64) | FK → `runtime.runtime`, INDEX | Links to execution cycle |
| + standard columns | | | sha, archive, date_created, date_modified |

### CodebookLogLevel

Reference table mapping Python logging levels. Seeded from `LogLevel` enum.

| Column | Type | Description |
|--------|------|-------------|
| `id` | Integer | Enum value from `LogLevel` |
| `description` | String(128) | Level name (DEBUG, INFO, WARNING, etc.) |
| `sha` | String(64) | Hash for merge() |
| `archive` | DateTime | NULL = active, timestamp = deprecated |
| `date_created` | DateTime | Server default NOW() |

## Pipeline Tables

### PipelineTask

Tracks document processing pipeline state. Each record represents one document being processed through pipeline stages (extraction, parsing, validation, loading). This table provides visibility into the Dramatiq-based document processing infrastructure described in [17.1. dramatiq.md](17.1.%20dramatiq.md#pipelinetask-state-tracking).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | BigInteger | PK, auto-increment | Unique identifier |
| `task_id` | String(64) | UNIQUE, INDEX | Unique task identifier (hash) |
| `document_type` | String(128) | INDEX | Type of document (e.g., "invoice", "financial_statement") |
| `source_path` | Text | | Path to the source document |
| `current_stage` | String(64) | | Current processing stage (extract, parse, validate, load) |
| `status` | String(32) | INDEX | Status: pending, in_progress, completed, failed, retry |
| `stage_history` | Text | | JSON array of completed stages with timestamps |
| `error_message` | Text | | Last error message (if failed) |
| `error_stage` | String(64) | | Stage where error occurred |
| `retry_count` | Integer | default: 0 | Number of retry attempts |
| `worker_id` | String(128) | | Dramatiq worker that processed this task |
| `app_id` | String(64) | INDEX | Hash ID of the app that submitted the task |
| `runtime` | String(64) | INDEX | Links to execution cycle |
| `start_time` | DateTime | | When processing started |
| `end_time` | DateTime | | When processing completed (or failed) |
| + standard columns | | | sha, archive, date_created, date_modified |

**Use case:** Query by `status='failed'` to find stuck documents, by `document_type` to monitor throughput per pipeline, or by `current_stage` to identify bottleneck stages.

## Proxy Tables

### ProxyReservation

Tracks IP address reservations for proxy management. When a thread acquires a proxy from a residential proxy service (BrightData, Oxylabs, etc.), the assigned IP is reserved per target domain to prevent other apps from using the same IP on the same site. See [15. proxy.md](15.%20proxy.md).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| `id` | Integer | PK, auto-increment | Unique identifier |
| `ip_address` | String(45) | INDEX | IPv4 or IPv6 address assigned by the proxy provider |
| `target_domain` | String(255) | INDEX | Target site domain (e.g., `gov.hr`) — lock scope |
| `app_id` | String(64) | INDEX | Hash ID of the app that reserved this IP |
| `reserved_at` | DateTime | | When the reservation was created |
| `ttl_seconds` | Integer | default: 1800 | Time-to-live in seconds (30 min default) — expired reservations are ignored |
| `released` | Boolean | default: false | Explicitly released on thread/session completion |

**Unique partial index (race condition safety):**

```sql
-- PostgreSQL
CREATE UNIQUE INDEX uq_proxy_reservation_ip_address ON proxy_reservation (ip_address, target_domain) WHERE released = false;

-- MSSQL (filtered index)
CREATE UNIQUE INDEX uq_proxy_reservation_ip_address ON proxy_reservation (ip_address, target_domain) WHERE released = 0;
```

This index guarantees no two active reservations can exist for the same IP + domain, preventing race conditions across threads, processes, and servers. See [15. proxy.md](15.%20proxy.md) for the atomic `_try_reserve()` pattern.

**TTL-based crash safety:** If an app crashes without releasing its reservation, the row auto-expires after `ttl_seconds`. The `_try_reserve()` method releases expired reservations before attempting a new INSERT.

## Codebook Tables

All codebook tables follow the codebook standard (id from enum, description, sha, archive, date_created). They are seeded by `Deploy.populate_tables()` which reads from the enum definitions.

### c_cmd_flags — Seeded from `CmdFlag`

| ID | Description |
|----|-------------|
| 0 | Command pending |
| 1 | Command executed |
| 2 | Command not executed, conditions not met |

### c_cmd_list — Seeded from `CmdName`

| ID | Description |
|----|-------------|
| 1 | Start app |
| 2 | Stop app |
| 3 | Restart app |
| 4 | Enable app |
| 5 | Disable app |

### c_fatal_flags — Seeded from `FatalFlag`

| ID | Description |
|----|-------------|
| 1 | Failed to start |
| 2 | App stopped, alert sent |
| 3 | Unexpected behaviour |

### c_run_status — Seeded from `RunStatus`

| ID | Description |
|----|-------------|
| 0 | App not running |
| 1 | App is running |
| 2 | App is stopped |

### c_log_level — Seeded from `LogLevel`

| ID | Description |
|----|-------------|
| 0 | NOTSET |
| 10 | DEBUG |
| 20 | INFO |
| 30 | WARNING |
| 40 | ERROR |
| 50 | CRITICAL |

### c_runtime_codes — Seeded from `RuntimeExitCode`

| ID | Description |
|----|-------------|
| 0 | App finished jobs and exited |
| 1 | App terminated, manager is exiting |
| 2 | App terminated (has PID list but no running status) |
| 3 | App killed by user command: disable |
| 4 | App killed by user command: reset |
| 5 | App killed by user command: stop |
| 6 | App killed by user command: start |

## Naming Conventions

All constraint names follow the pattern defined in `data_collector/tables/shared.py`:

| Type | Pattern | Example |
|------|---------|---------|
| Index | `ix_%(table_name)s_%(column_0_label)s` | `ix_apps_app` |
| Unique | `uq_%(table_name)s_%(column_0_name)s` | `uq_app_groups_name` |
| Check | `ck_%(table_name)s_%(constraint_name)s` | `ck_apps_status_range` |
| Foreign Key | `fk_%(table_name)s_%(column_0_name)s_%(referred_table_name)s` | `fk_logs_app_id_apps` |
| Primary Key | `pk_%(table_name)s` | `pk_apps` |

## Schema Migration Strategy

**Current approach:** The `Deploy` class provides create/drop/recreate operations via SQLAlchemy's `metadata.create_all()` and `metadata.drop_all()`.

**Production recommendation:** For production environments with existing data, integrate Alembic for incremental schema migrations. The `Deploy.recreate_tables()` method should only be used in development.
