[← Back to index](1.%20index.md)

# PDF & OCR Processing

**Implementation Status:** In Development | **Phase:** 4 (v0.4.0)

## Overview

Extract structured data from PDF documents and scanned images. Built from the ground up based on enterprise experience. Uses **pdfplumber** as the primary PDF text extraction library and an OCR adapter pattern supporting multiple engines.

Developed and tested primarily on Windows, but fully deployable on Linux.

## PDF Processing Flow

```
Input PDF
    |
    v
Classify Document (text-based vs image-based)
    |
    +--- 90%+ pages have extractable text ---> Text Path (pdfplumber)
    |
    +--- Otherwise ----------------------------> Image Path (OCR engine)
    |
    v
Structured Output
```

### Whole-Document Classification

The framework classifies each PDF as **text-based** or **image-based** using a 90% threshold:

- If **90% or more** of pages have extractable text -> **text mode** (use pdfplumber)
- Otherwise -> **image/OCR mode** (use OCR engine)

There is no per-page mixed mode. The entire document is processed through one path.

```python
import pdfplumber

def classify_pdf(pdf_path: str, threshold: float = 0.9) -> str:
    """Classify a PDF as 'text' or 'image' based on extractable text content."""
    with pdfplumber.open(pdf_path) as pdf:
        text_pages = 0
        for page in pdf.pages:
            text = page.extract_text()
            if text and len(text.strip()) > 50:  # meaningful text content
                text_pages += 1
        ratio = text_pages / len(pdf.pages) if pdf.pages else 0
        return "text" if ratio >= threshold else "image"
```

## Text Extraction (pdfplumber)

**pdfplumber** is the primary library for all PDF text and table extraction.

```python
import pdfplumber

with pdfplumber.open("document.pdf") as pdf:
    for page in pdf.pages:
        text = page.extract_text()
        tables = page.extract_tables()
```

### Table Extraction

```python
with pdfplumber.open("financial_report.pdf") as pdf:
    page = pdf.pages[0]
    table = page.extract_table()
    # Returns list of lists: [['Header1', 'Header2'], ['val1', 'val2'], ...]
```

| Tool | Strengths | Limitations |
|------|-----------|-------------|
| **pdfplumber** | High accuracy, text + table extraction, detailed control | Native PDFs only |
| **Camelot** | Good for lattice tables | Requires Ghostscript |
| **Tabula** | Easy setup | Less flexible |

## OCR Engine

### OCR Adapter Pattern

The framework uses an `OCREngine` adapter with pluggable implementations:

```python
from abc import ABC, abstractmethod

class OCREngine(ABC):
    """Abstract OCR engine interface."""

    @abstractmethod
    def extract_text(self, image) -> str:
        """Extract text from a PIL Image."""
        ...

class TesseractEngine(OCREngine):
    """Default OCR engine — Tesseract via pytesseract."""

    def extract_text(self, image) -> str:
        import pytesseract
        return pytesseract.image_to_string(image, lang=self.lang)

class PaddleOCREngine(OCREngine):
    """Optional OCR engine — requires separate install of paddleocr."""

    def extract_text(self, image) -> str:
        result = self.ocr.ocr(image, cls=True)
        return "\n".join(line[1][0] for line in result[0])
```

### Tesseract (Default)

```python
import pytesseract
from PIL import Image

text = pytesseract.image_to_string(Image.open("scan.png"), lang="eng+hrv")
```

### PaddleOCR (Optional)

Requires separate installation (`pip install paddleocr`).

```python
from paddleocr import PaddleOCR

ocr = PaddleOCR(use_angle_cls=True, lang='en')
result = ocr.ocr("document.png", cls=True)
for line in result[0]:
    text = line[1][0]
    confidence = line[1][1]
```

### Engine Comparison

| Engine | Accuracy | Speed | Languages | Layout | Install |
|--------|----------|-------|-----------|--------|---------|
| Tesseract | Good | Fast (CPU) | 100+ | Basic | Default |
| PaddleOCR | Very good | Medium | 80+ | Advanced | Optional |

### Image Preprocessing Pipeline

For optimal OCR results, preprocess images before extraction:

```
Input Image
    |
    v
Deskew (correct rotation)
    |
    v
Binarize (convert to B&W)
    |
    v
Denoise (remove noise)
    |
    v
Upscale (if DPI < 300)
    |
    v
OCR Engine
```

Libraries: **OpenCV** for preprocessing, **Pillow** for format conversion.

## Integration with Framework

PDF/OCR processing integrates at two levels: inline within a scraper's `collect()` method (for simple cases), or as a standalone Dramatiq worker stage in a multi-step pipeline (for high-volume document processing).

### Inline in BaseScraper

For scrapers that download and process PDFs as part of collection:

```python
class CourtFilings(BaseScraper):
    def collect(self):
        for case in self.work_list:
            pdf_bytes = self.request.get(case.pdf_url).content
            pdf_path = save_temp(pdf_bytes)

            doc_type = classify_pdf(pdf_path)
            if doc_type == "text":
                text = extract_text_pdfplumber(pdf_path)
            else:
                text = extract_text_ocr(pdf_path, engine=TesseractEngine())

            records = self.parser.parse_filing(text, case.case_id)
            self.store(records)
            self.solved += 1
```

### As a Pipeline Stage (Dramatiq Worker)

For high-volume document processing, PDF/OCR runs as a Dramatiq worker stage with state tracked in `PipelineTask`. See [17.1. dramatiq.md](17.1.%20dramatiq.md#generic-infrastructure-actor) for the `process_pdf` actor pattern.

```python
# Classify → extract text → forward to next stage
doc_type = classify_pdf(pdf_path)

if doc_type == "text":
    pdf_text = extract_text_pdfplumber(pdf_path)
else:
    pdf_text = extract_text_ocr(pdf_path, engine=TesseractEngine())

records = parse_company_data(pdf_text)
bulk_hash(records)

with database.create_session() as session:
    database.merge(records, session, filters=filters)
```

## Recommended Libraries

| Library | Purpose | Status |
|---------|---------|--------|
| `pdfplumber` | PDF text + table extraction (primary) | To be added |
| `pytesseract` | Tesseract OCR wrapper (default engine) | To be added |
| `Pillow` | Image manipulation | To be added |
| `opencv-python` | Image preprocessing | To be added |
| `paddleocr` | Advanced OCR (optional engine) | To be added |

## Dependencies

- **pdfplumber** — PDF text and table extraction (primary)
- **pytesseract** — Tesseract OCR wrapper (default engine)
- **Pillow** — Image manipulation and format conversion
- **opencv-python** — Image preprocessing (deskew, binarize, denoise)
- **paddleocr** — Advanced OCR engine (optional, separate install)
- NER pipeline for entity extraction ([21. deep-learning-ner.md](21.%20deep-learning-ner.md))
- OCR output feeds into Dramatiq pipeline workers ([17.1. dramatiq.md](17.1.%20dramatiq.md#worker-patterns))
- Dramatiq + RabbitMQ for pipeline worker stages ([17. rabbitmq.md](17.%20rabbitmq.md))
