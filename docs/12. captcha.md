[← Back to index](1.%20index.md)

# Captcha Solving

**Implementation Status:** IN DEVELOPMENT | **Work Package:** WP-06 | **Milestone:** v0.3.0

## Overview

AntiCaptcha integration for automated captcha resolution during data collection. Handles reCAPTCHA v2/v3, hCaptcha, and image captchas encountered during scraping workflows. All HTTP communication with the AntiCaptcha API uses the centralized `Request` class ([4.4. request.md](4.4.%20request.md)).

## Setup

1. **Create an AntiCaptcha account** — [Sign up here](https://anti-captcha.com/?from=your_referral_id) to get started
2. **Get your API key** from the AntiCaptcha dashboard → Settings → API Key
3. **Set the environment variable:**
   ```bash
   export CAPTCHA_API_KEY="your_anticaptcha_api_key"
   ```

## Supported Captcha Types

| Type | Detection | Solution Method |
|------|-----------|----------------|
| Image captcha | `<img>` with distorted text | Submit image → receive text |
| reCAPTCHA v2 | `g-recaptcha` div with sitekey | Submit sitekey + URL → receive token |
| reCAPTCHA v3 | `grecaptcha.execute()` in JS | Submit sitekey + URL + action → receive token |
| hCaptcha | `h-captcha` div | Submit sitekey + URL → receive token |

## Architecture

```
Page Load → Detect Captcha → Extract Parameters
                                    │
                    ┌───────────────┴───────────────┐
                    ▼                               ▼
            Image Captcha                    reCAPTCHA/hCaptcha
                    │                               │
            Submit image                    Submit sitekey + URL
            to AntiCaptcha                  to AntiCaptcha
            (via Request class)             (via Request class)
                    │                               │
                    ▼                               ▼
            Poll for result                 Poll for result
            (text answer)                   (token string)
                    │                               │
                    ▼                               ▼
            Fill input field                Inject token into
            + submit form                   g-recaptcha-response
```

## Usage Pattern

```python
from data_collector.utilities.request import Request
from data_collector.captcha import AntiCaptcha

captcha_solver = AntiCaptcha(
    api_key=os.getenv("CAPTCHA_API_KEY"),
    request=Request(timeout=120)
)

# For reCAPTCHA v2:
token = captcha_solver.solve_recaptcha_v2(
    site_key="6Le-wvkSAAAAAPBM...",
    page_url="https://example.com/form"
)
# Inject token into form submission

# For image captcha:
answer = captcha_solver.solve_image(image_bytes)
# Fill in the text field
```

### Integration with BaseScraper

AntiCaptcha is typically used inside a scraper's `collect()` method when a captcha is encountered:

```python
class ProtectedPortal(BaseScraper):
    base_url = "https://portal.example.com"

    def __init__(self, database, **kwargs):
        super().__init__(database, **kwargs)
        self.captcha = AntiCaptcha(
            api_key=os.getenv("CAPTCHA_API_KEY"),
            request=Request(timeout=120)
        )

    def collect(self):
        for item in self.work_list:
            response = self.request.get(f"{self.base_url}/search/{item.reg_number}")

            # Detect and solve captcha if present
            site_key = detect_recaptcha(response.content)
            if site_key:
                token = self.captcha.solve_recaptcha_v2(
                    site_key=site_key,
                    page_url=f"{self.base_url}/search/{item.reg_number}"
                )
                # Resubmit with captcha token
                response = self.request.post(
                    f"{self.base_url}/search",
                    data={"g-recaptcha-response": token, "query": item.reg_number}
                )

            data = parse_results(response.content)
            self.store(data)
            self.solved += 1
```

## Configuration

| Setting | Description |
|---------|-------------|
| `captcha_api_key` | AntiCaptcha API key (from environment variable) |
| `captcha_timeout` | Max seconds to wait for solution (default: 120) |
| `captcha_max_retries` | Retries on timeout or error (default: 2) |

## Cost Tracking

Track captcha costs per app:
- Requests submitted
- Requests solved
- Requests timed out
- Total cost per run

## Dependencies

- **Request class** ([4.4. request.md](4.4.%20request.md)) — HTTP communication with AntiCaptcha API
- Scraping engine ([11. scraping.md](11.%20scraping.md))

